name: Build and Test

on:
  push:
    branches:
      - '**'
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event.number || github.sha }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

env:
  DOTNET_VERSION: '8.0.x'
  CONFIGURATION: Release
  CONDUCTOR_API_URL: "http://localhost:8080/api"
  CONDUCTOR_COMPOSE_FILE: conductor/docker/docker-compose.yaml
  CONDUCTOR_TIMEOUT: 200
  CONDUCTOR_CHECK_INTERVAL: 30

permissions:
  contents: read
  checks: write

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Build Solution
      run: |
        dotnet restore SdkTestAutomation.sln
        dotnet build SdkTestAutomation.sln --configuration ${{ env.CONFIGURATION }} --no-restore

    - name: Checkout Conductor Repository
      uses: actions/checkout@v4
      with:
        repository: conductor-oss/conductor
        ref: main
        path: conductor

    - name: Start Conductor Services
      run: |
        docker compose -f ${{ env.CONDUCTOR_COMPOSE_FILE }} up -d
        
        echo "Waiting for services to initialize..."
        timeout=${{ env.CONDUCTOR_TIMEOUT }}
        check_interval=${{ env.CONDUCTOR_CHECK_INTERVAL }}
        
        while [ $timeout -gt 0 ]; do
          # Check container health
          if docker compose -f ${{ env.CONDUCTOR_COMPOSE_FILE }} ps | grep -q "healthy"; then
            # Check API health
            if curl -s ${{ env.CONDUCTOR_API_URL }}/health > /dev/null 2>&1; then
              echo "SUCCESS: Conductor API is ready!"
              exit 0
            fi
          fi
          
          # Log status periodically
          if [ $((timeout % check_interval)) -eq 0 ]; then
            echo "Services status (${timeout}s remaining):"
            docker compose -f ${{ env.CONDUCTOR_COMPOSE_FILE }} ps
            docker compose -f ${{ env.CONDUCTOR_COMPOSE_FILE }} logs --tail=20 conductor-server
          fi
          
          echo "Waiting for API... (${timeout}s remaining)"
          sleep 10
          timeout=$((timeout-10))
        done
        
        echo "ERROR: Conductor API failed to become healthy"
        docker compose -f ${{ env.CONDUCTOR_COMPOSE_FILE }} ps
        docker compose -f ${{ env.CONDUCTOR_COMPOSE_FILE }} logs conductor-server
        exit 1

    - name: Run Tests
      id: test-run
      run: |
        mkdir -p TestResults
        ./SdkTestAutomation.Tests/bin/${{ env.CONFIGURATION }}/net8.0/SdkTestAutomation.Tests \
          -html TestResults/test-results.html \
          -trx TestResults/test-results.trx \
          -jUnit TestResults/test-results.xml 2>&1
      continue-on-error: true

    - name: Setup Node.js for reporting
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install html-to-markdown
      run: npm install -g @tehshrike/html-to-markdown

    - name: Create Test Summary
      if: always()
      run: |
        # Create a summary file
        echo "# Test Results" > TestResults/summary.md
        echo "" >> TestResults/summary.md
        echo "## Detailed Test Report" >> TestResults/summary.md
        echo "" >> TestResults/summary.md
        
        if [ -f "TestResults/test-results.html" ]; then
          # Extract test results section (adjust selectors if needed)
          html-to-markdown TestResults/test-results.html \
            --selectors "div.test-results, div.test-summary, div.test-details" \
            --tables \
            --bullets \
            >> TestResults/summary.md
        else
          echo "No test results HTML file found." >> TestResults/summary.md
        fi

    - name: Publish Test Results (TRX)
      if: always()
      uses: dorny/test-reporter@v1
      with:
        name: Test Results (TRX)
        path: TestResults/test-results.trx
        reporter: dotnet-trx
        fail-on-error: false

    - name: Publish Test Results (JUnit)
      if: always()
      uses: dorny/test-reporter@v1
      with:
        name: Test Results (JUnit)
        path: TestResults/test-results.xml
        reporter: java-junit
        fail-on-error: false

    - name: Add Test Report to Job Summary
      if: always()
      run: cat TestResults/summary.md >> $GITHUB_STEP_SUMMARY

    - name: Display Test Report List
      if: always()
      run: |
        {
          echo ""
          echo "## Available Test Reports"
          echo "ðŸ“Š Test reports available in:"
          echo "- HTML: Rich interactive report"
          echo "- TRX: Native .NET test results"
          echo "- JUnit: Standard XML format"
        } >> $GITHUB_STEP_SUMMARY

    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: TestResults
        if-no-files-found: warn

    - name: Cleanup Conductor
      if: always()
      run: docker compose -f ${{ env.CONDUCTOR_COMPOSE_FILE }} down